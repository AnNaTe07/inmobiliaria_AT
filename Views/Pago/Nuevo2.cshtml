@using System.Globalization
@model inmobiliaria_AT.Models.Pago

@{
    ViewData["Title"] = "Nuevo Pago";
    int? id = Model == null ? 0 : Model.Id;
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white text-center">
                    <h2>@ViewData["Title"]</h2>
                </div>
                <div class="card-body">
                    <!-- Mostrar el número de pago -->
                    <div class="mb-3">
                        <h5>Número de Pago: @ViewBag.NumeroPago</h5>
                    </div>
                    <form asp-action="Nuevo" method="post">
                        @*
                        <div class="form-group mb-3">
                        <label asp-for="Contrato.Id" class="form-label">Contrato</label>
                        <select asp-for="Contrato.Id"
                        asp-items="@(ViewBag.Contratos ?? new SelectList(Enumerable.Empty<SelectListItem>()))"
                        class="form-control select2" id="contratoSelect">
                        <option value="">Seleccione un contrato</option>
                        </select>
                        <span asp-validation-for="Contrato.Id" class="text-danger"></span>
                        </div>




                        <div class="form-group mb-3">
                        <label asp-for="Monto" class="form-label">Monto</label>
                        <input asp-for="Monto" id="montoContrato" class="form-control" readonly />
                        <span asp-validation-for="Monto" class="text-danger"></span>
                        </div>*@

                        <div class="form-group mb-3">
                            <label asp-for="Contrato.Id" class="form-label">Contrato</label>
                            <select asp-for="Contrato.Id"
                                asp-items="@(ViewBag.Contratos ?? new SelectList(Enumerable.Empty<SelectListItem>()))"
                                class="form-control select2" id="contratoSelect">
                                <option value="">Seleccione un contrato</option>
                            </select>
                            <span asp-validation-for="Contrato.Id" class="text-danger"></span>
                        </div>

                        <div class="form-group mb-3">
                            <label asp-for="Monto" class="form-label">Monto</label>
                            <input asp-for="Monto" id="montoContrato" class="form-control" readonly />
                            <input type="hidden" id="importeHidden" name="Importe" value="@ViewBag.Importe" />
                            <span asp-validation-for="Monto" class="text-danger"></span>
                        </div>
                        <!-- Campo Detalle -->
                        <div class="form-group mb-3">
                            <label asp-for="Detalle" class="form-label">Detalle</label>
                            <textarea asp-for="Detalle" class="form-control"></textarea>
                            <span asp-validation-for="Detalle" class="text-danger"></span>
                        </div>

                        <!-- Botón de Guardar -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success">Guardar Pago</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inicializa Select2 con funcionalidad de búsqueda para ambos select 
<script>
    $(document).ready(function () {
        $('.select2').select2({
            placeholder: "Seleccione una opción",
            allowClear: true,
            width: '100%',
            minimumResultsForSearch: 0 // Activa la búsqueda siempre
        });
    });
    $('#contratoSelect').on('select2:select', function (e) {
        var contratoId = $(this).val();

        if (contratoId) {
            // Realiza la llamada AJAX para obtener el precio del inmueble asociado al contrato
            $.ajax({
                url: '@Url.Action("ObtenerInmueblesDisponibles", "Contrato")',
                type: 'GET',
                data: { id: contratoId },
                success: function (data) {
                    if (data && data.Precio) { // Cambia aquí
                        $('#montoContrato').val(data.Precio); // Asigna el precio al campo de Monto
                    } else {
                        $('#montoContrato').val(''); // Limpia el campo si no hay precio
                    }
                },
                error: function () {
                    alert('Error al cargar los detalles del contrato.');
                }
            });
        } else {
            $('#montoContrato').val(''); // Limpia el campo si no hay contrato seleccionado
        }
    });
    $('#contratoSelect').on('select2:select', function (e) {
    var precioInmueble = $(this).find('option:selected').data('precio');
    $('#montoContrato').val(precioInmueble || ''); // Asigna el precio o limpia
});

    /* $('#contratoSelect').on('select2:select', function (e) {
     var precioInmueble = $(this).find('option:selected').data('precio'); // Obtener el precio del inmueble seleccionado
     if (precioInmueble) {
         $('#montoContrato').val(precioInmueble); // Actualiza el valor del input con el precio
     } else {
         $('#montoContrato').val(''); // Limpia el campo si no hay selección
     }
 });


      $('#contratoSelect').on('select2:select', function (e) {
              var precioInmueble = $(this).find('option:selected').data('precio'); // Obtener el precio del inmueble seleccionado
              if (precioInmueble) {
                  $('#montoContrato').val(precioInmueble); // Actualiza el valor del input con el precio
              } else {
                  $('#montoContrato').val(''); // Limpia el campo si no hay selección
              }
          });*/

</script>

<script>

    $(document).ready(function () {
        $('.select2').select2({
            placeholder: "Seleccione una opción",
            allowClear: true,
            width: '100%',
            minimumResultsForSearch: 0
        });

        $('#contratoSelect').on('change', function () {
            var contratoId = $(this).val();
            if (contratoId) {
                $.ajax({
                    url: '@Url.Action("ObtenerPorIdJSON", "Contrato")',
                    type: 'GET',
                    data: { id: contratoId },
                    success: function (data) {
                        if (data) {
                            // Actualiza el campo con el precio del contrato
                            $('#montoContrato').val(data.Precio); // Asegúrate de usar el ID correcto
                        } else {
                            $('#montoContrato').val(''); // Limpia el campo si no hay precio
                        }
                    },
                    error: function () {
                        alert('Error al cargar los detalles del contrato.');
                    }
                });
            } else {
                $('#montoContrato').val(''); // Limpia el campo si no hay selección
            }
        });
    });

</script>-->
<script>
    $(document).ready(function () {
        $('.select2').select2({
            placeholder: "Seleccione una opción",
            allowClear: true,
            width: '100%'
        });

        $('#contratoSelect').on('change', function () {
            var contratoId = $(this).val();
            if (contratoId) {
                $.ajax({
                    url: '@Url.Action("ObtenerPorIdJSON", "Contrato")',
                    type: 'GET',
                    data: { id: contratoId },
                    success: function (data) {
                        if (data) {
                            $('#montoContrato').val(data.Precio);
                            $('#importeHidden').val(data.Precio); // Actualiza el campo oculto
                        } else {
                            $('#montoContrato').val('');
                            $('#importeHidden').val(''); // Limpia el campo oculto si no hay precio
                        }
                    },
                    error: function () {
                        alert('Error al cargar los detalles del contrato.');
                    }
                });
            } else {
                $('#montoContrato').val('');
                $('#importeHidden').val(''); // Limpia el campo oculto si no hay selección
            }
        });
    });
</script>
<!-- Scripts de validación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate-unobtrusive/3.2.11/jquery.validate.unobtrusive.min.js"></script>
<link rel="stylesheet" href="../../css/pago.css">